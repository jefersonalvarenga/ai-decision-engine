# EasyScale - Diagramas de Arquitetura

## ğŸ“ VisÃ£o Geral do Sistema

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         EasyScale System                             â”‚
â”‚                     (Aesthetic Clinic AI Assistant)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ WhatsApp â”‚
                              â”‚ Business â”‚
                              â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                                    â”‚
                    Mensagem PT-BR  â”‚ "quanto custa o botox?"
                                    â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚   FastAPI Server â”‚
                          â”‚   (api.py)       â”‚
                          â”‚  Port: 8000      â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                             â”‚
         1. Fetch Context                  2. Route Message
                    â”‚                             â”‚
                    â–¼                             â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Supabase DB      â”‚        â”‚  Router Agent       â”‚
        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚        â”‚  (LangGraph)        â”‚
        â”‚ view_context_      â”‚        â”‚                     â”‚
        â”‚   hydration        â”‚        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚                    â”‚        â”‚  â”‚  DSPy Module  â”‚  â”‚
        â”‚ â€¢ active_items     â”‚        â”‚  â”‚  (LLM Call)   â”‚  â”‚
        â”‚ â€¢ behavioral_      â”‚        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â”‚   profile          â”‚        â”‚                     â”‚
        â”‚ â€¢ conversation_    â”‚        â”‚  Intent Detection   â”‚
        â”‚   history          â”‚        â”‚  + Urgency Score    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚      Conditional Routing Logic           â”‚
                            â”‚      (Priority-based)                    â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                   â”‚
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚                 â”‚                  â”‚                  â”‚             â”‚
        Priority 1        Priority 2         Priority 3         Priority 4    Priority 5
             â”‚                 â”‚                  â”‚                  â”‚             â”‚
             â–¼                 â–¼                  â–¼                  â–¼             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Medical Agent  â”‚ â”‚Scheduler Agent â”‚ â”‚Closer Agent  â”‚ â”‚  FAQ Agent   â”‚ â”‚   END   â”‚
    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚               â”‚ â”‚               â”‚ â”‚              â”‚ â”‚              â”‚
    â”‚ URGENT        â”‚ â”‚ Booking       â”‚ â”‚ Sales        â”‚ â”‚ Technical    â”‚
    â”‚ Health Issues â”‚ â”‚ Appointments  â”‚ â”‚ Pricing      â”‚ â”‚ Questions    â”‚
    â”‚               â”‚ â”‚               â”‚ â”‚              â”‚ â”‚              â”‚
    â”‚ Score: 4-5    â”‚ â”‚ Score: 2-3    â”‚ â”‚ Score: 1-2   â”‚ â”‚ Score: 1     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                 â”‚                 â”‚                 â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚  Final Response  â”‚
                          â”‚  (PT-BR)         â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚    WhatsApp      â”‚
                          â”‚  "O Botox custa  â”‚
                          â”‚  R$ 800. Posso   â”‚
                          â”‚  parcelar..."    â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ Fluxo de Dados Detalhado

### Fase 1: RecepÃ§Ã£o da Mensagem

```
WhatsApp Message
       â†“
POST /api/v1/whatsapp/webhook
{
  "patient_id": "p_12345",
  "message": "quanto custa o botox?",
  "phone": "+5511999999999",
  "timestamp": "2026-01-20T15:30:00Z"
}
```

### Fase 2: HidrataÃ§Ã£o do Contexto

```sql
-- Query executada no Supabase
SELECT * FROM view_context_hydration
WHERE patient_id = 'p_12345';

-- Retorna:
{
  "patient_id": "p_12345",
  "active_items": [
    {
      "service_name": "Botox",
      "price": 800.0,
      "status": "quoted"
    }
  ],
  "behavioral_profile": {
    "communication_style": "direct",
    "price_sensitivity": "high",
    "decision_speed": "fast"
  },
  "conversation_history": [
    {"role": "patient", "text": "Oi, tenho interesse"},
    {"role": "agent", "text": "OlÃ¡! Como posso ajudar?"}
  ]
}
```

### Fase 3: ClassificaÃ§Ã£o de IntenÃ§Ã£o (DSPy)

```
Input:
  context_json = {contexto do Supabase}
  patient_message = "quanto custa o botox?"

DSPy Signature (RouterSignature):
  â†“
  Chain of Thought Reasoning
  â†“
Output:
  intents = ["SALES"]
  urgency_score = 2
  reasoning = "Customer asking about pricing for Botox service.
               Keywords detected: 'quanto custa' (how much does it cost).
               No urgency indicators present."
```

### Fase 4: Roteamento Condicional

```python
def should_continue(state):
    intent_queue = ["SALES"]

    # Check priority order:
    if "MEDICAL_ASSESSMENT" in intent_queue:  # âŒ NÃ£o
        return "medical_agent"

    if "SCHEDULING" in intent_queue:  # âŒ NÃ£o
        return "scheduler_agent"

    if "SALES" in intent_queue:  # âœ… Sim!
        return "closer_agent"

    # ...

# Result: Routes to CLOSER AGENT
```

### Fase 5: ExecuÃ§Ã£o do Agente Especializado

```
Closer Agent (Placeholder):
  â†“
  [Future: Consulta tabela de preÃ§os]
  [Future: Aplica descontos baseados no perfil]
  [Future: Gera proposta personalizada]
  â†“
Output:
  final_response = "O Botox custa R$ 800,00.
                   Posso parcelar em atÃ© 3x sem juros no cartÃ£o.
                   Gostaria de agendar uma avaliaÃ§Ã£o?"
```

### Fase 6: PersistÃªncia e Resposta

```
1. Log no Supabase:
   INSERT INTO conversation_logs (
     patient_id, message_in, message_out, intents, urgency_score
   ) VALUES (
     'p_12345',
     'quanto custa o botox?',
     'O Botox custa R$ 800...',
     ['SALES'],
     2
   );

2. Retorno para WhatsApp:
   {
     "response": "O Botox custa R$ 800,00...",
     "urgency": 2
   }
```

## ğŸ§  Arquitetura do Router Agent (Detalhada)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        AgentState (TypedDict)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ context: dict                  [JSON do Supabase]                â”‚
â”‚  â€¢ latest_message: str            [Mensagem PT-BR]                  â”‚
â”‚  â€¢ intent_queue: List[str]        [IntenÃ§Ãµes detectadas]            â”‚
â”‚  â€¢ final_response: str            [Resposta acumulada]              â”‚
â”‚  â€¢ urgency_score: int             [1-5 score]                       â”‚
â”‚  â€¢ reasoning: str                 [LÃ³gica interna em inglÃªs]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      LangGraph Workflow                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  START                                                               â”‚
â”‚    â”‚                                                                 â”‚
â”‚    â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚  router_node                             â”‚                       â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚                       â”‚
â”‚  â”‚  1. Converte context para JSON          â”‚                       â”‚
â”‚  â”‚  2. Chama DSPy RouterModule              â”‚                       â”‚
â”‚  â”‚  3. Atualiza intent_queue                â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                   â”‚                                                  â”‚
â”‚                   â–¼                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚  should_continue (Conditional)           â”‚                       â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚                       â”‚
â”‚  â”‚  LÃª intent_queue e rota baseado em       â”‚                       â”‚
â”‚  â”‚  prioridade:                             â”‚                       â”‚
â”‚  â”‚  1. MEDICAL_ASSESSMENT (urgÃªncia)        â”‚                       â”‚
â”‚  â”‚  2. SCHEDULING (time-sensitive)          â”‚                       â”‚
â”‚  â”‚  3. SALES (comercial)                    â”‚                       â”‚
â”‚  â”‚  4. TECH_FAQ (informacional)             â”‚                       â”‚
â”‚  â”‚  5. END (vazio)                          â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                   â”‚                                                  â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚       â”‚           â”‚           â”‚           â”‚          â”‚              â”‚
â”‚       â–¼           â–¼           â–¼           â–¼          â–¼              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚Medical  â”‚ â”‚Schedulerâ”‚ â”‚Closer  â”‚ â”‚FAQ     â”‚  â”‚ END â”‚           â”‚
â”‚  â”‚Agent    â”‚ â”‚Agent    â”‚ â”‚Agent   â”‚ â”‚Agent   â”‚  â””â”€â”€â”€â”€â”€â”˜           â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                     â”‚
â”‚       â”‚           â”‚           â”‚          â”‚                          â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                   â”‚                                                  â”‚
â”‚                   â–¼                                                  â”‚
â”‚                  END                                                 â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ DSPy Router Module (Internal)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     RouterModule (DSPy)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  Input:                                                              â”‚
â”‚    â€¢ context_json: str    (serialized patient context)              â”‚
â”‚    â€¢ patient_message: str (PT-BR message)                           â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  RouterSignature (dspy.Signature)                          â”‚    â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚    â”‚
â”‚  â”‚                                                            â”‚    â”‚
â”‚  â”‚  Instructions (System Prompt):                            â”‚    â”‚
â”‚  â”‚  "You are an intent classifier for a Brazilian           â”‚    â”‚
â”‚  â”‚   aesthetic clinic. Understand PT-BR colloquialisms:     â”‚    â”‚
â”‚  â”‚   - 'tÃ¡ caro' = price concern (SALES)                    â”‚    â”‚
â”‚  â”‚   - 'quero marcar' = booking intent (SCHEDULING)         â”‚    â”‚
â”‚  â”‚   - 'fiquei com alergia' = medical concern (MEDICAL)     â”‚    â”‚
â”‚  â”‚   - 'como funciona?' = technical question (FAQ)          â”‚    â”‚
â”‚  â”‚   Always prioritize MEDICAL_ASSESSMENT if any health     â”‚    â”‚
â”‚  â”‚   concern is detected."                                  â”‚    â”‚
â”‚  â”‚                                                            â”‚    â”‚
â”‚  â”‚  Chain of Thought:                                        â”‚    â”‚
â”‚  â”‚  1. Analyze the patient message                           â”‚    â”‚
â”‚  â”‚  2. Consider conversation history                         â”‚    â”‚
â”‚  â”‚  3. Identify keywords and intent signals                  â”‚    â”‚
â”‚  â”‚  4. Classify into one or more intent types                â”‚    â”‚
â”‚  â”‚  5. Assess urgency level (1-5)                            â”‚    â”‚
â”‚  â”‚  6. Provide reasoning                                     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                      â”‚
â”‚  Output:                                                             â”‚
â”‚    â€¢ intents: List[str]      ["SALES", "SCHEDULING"]                â”‚
â”‚    â€¢ urgency_score: int      2                                      â”‚
â”‚    â€¢ reasoning: str          "Customer asking about price..."       â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š Exemplo de Fluxo Completo (Multi-Intent)

```
Input Message: "fiz o procedimento ontem e estÃ¡ muito inchado,
                quanto custa para refazer se der problema?"

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: Router Classification                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
DSPy Output:
  intents = ["MEDICAL_ASSESSMENT", "SALES"]
  urgency_score = 4
  reasoning = "Patient reports significant swelling after procedure.
               Keywords: 'muito inchado' (very swollen).
               Secondary question about pricing for redo.
               Medical concern takes priority."

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: Conditional Routing                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
should_continue() checks:
  â“ intent_queue empty? â†’ No
  âœ… MEDICAL_ASSESSMENT in queue? â†’ YES! â†’ Route to medical_agent

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: Medical Agent Execution                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Medical Agent (Future Implementation):
  1. Assess severity from description
  2. Check if within post-procedure window
  3. Determine if requires immediate clinic visit
  4. Generate appropriate response

Output:
  final_response = "Entendo sua preocupaÃ§Ã£o. InchaÃ§o apÃ³s o procedimento
                   pode ser normal nas primeiras 48h, mas vamos avaliar.
                   Vou encaminhar seu caso para nossa enfermeira
                   imediatamente. Ela entrarÃ¡ em contato nos prÃ³ximos
                   15 minutos. Enquanto isso, mantenha gelo na regiÃ£o
                   (15min ligado, 15min desligado). VocÃª estÃ¡ sentindo dor?"

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4: Response & Logging                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Log to Supabase:
  urgency_score = 4  â†’  Triggers alert to clinic staff

Send to WhatsApp:
  Immediate response with instructions

Create task:
  Nurse follow-up required within 15 minutes
```

## ğŸ› ï¸ Stack TÃ©cnico

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Technology Stack                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  Backend Framework:                                          â”‚
â”‚    â€¢ FastAPI (REST API)                                      â”‚
â”‚    â€¢ Uvicorn (ASGI Server)                                   â”‚
â”‚                                                              â”‚
â”‚  AI/ML Layer:                                                â”‚
â”‚    â€¢ DSPy (Structured LLM Programming)                       â”‚
â”‚    â€¢ LangGraph (Agent Orchestration)                         â”‚
â”‚    â€¢ OpenAI GPT-4o-mini (Primary LLM)                        â”‚
â”‚    â€¢ Anthropic Claude 3.5 Sonnet (Alternative)               â”‚
â”‚    â€¢ Groq Llama 3.3 70B (Open Source Option)                 â”‚
â”‚                                                              â”‚
â”‚  Database:                                                   â”‚
â”‚    â€¢ Supabase (PostgreSQL 14+)                               â”‚
â”‚    â€¢ Custom Views for Context Hydration                      â”‚
â”‚                                                              â”‚
â”‚  Messaging:                                                  â”‚
â”‚    â€¢ WhatsApp Business API                                   â”‚
â”‚                                                              â”‚
â”‚  Infrastructure:                                             â”‚
â”‚    â€¢ Docker (Containerization)                               â”‚
â”‚    â€¢ Railway/Render (Hosting)                                â”‚
â”‚    â€¢ GitHub Actions (CI/CD)                                  â”‚
â”‚                                                              â”‚
â”‚  Monitoring:                                                 â”‚
â”‚    â€¢ Sentry (Error Tracking)                                 â”‚
â”‚    â€¢ LangSmith (LLM Observability)                           â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ˆ MÃ©tricas de Performance

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Performance Targets                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Latency:                                                   â”‚
â”‚    â€¢ P50: < 800ms   (median response time)                  â”‚
â”‚    â€¢ P95: < 2000ms  (95th percentile)                       â”‚
â”‚    â€¢ P99: < 3000ms  (99th percentile)                       â”‚
â”‚                                                             â”‚
â”‚  Classification Accuracy:                                   â”‚
â”‚    â€¢ Intent Detection: > 90%                                â”‚
â”‚    â€¢ Urgency Scoring: > 85%                                 â”‚
â”‚                                                             â”‚
â”‚  Throughput:                                                â”‚
â”‚    â€¢ Concurrent Requests: 100+                              â”‚
â”‚    â€¢ Messages/Second: 50+                                   â”‚
â”‚                                                             â”‚
â”‚  Cost (per 1000 messages):                                  â”‚
â”‚    â€¢ GPT-4o-mini: ~$0.15                                    â”‚
â”‚    â€¢ Claude Haiku: ~$0.25                                   â”‚
â”‚    â€¢ Groq (free tier): $0.00                                â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Diagrama criado em:** 2026-01-20
**VersÃ£o:** 1.0.0
